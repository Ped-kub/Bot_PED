client.on('messageCreate', async message => {
    if (message.author.bot) return;

    // --- 1. คำสั่งสำหรับตั้งค่าห้องเพลง ---
    if (message.content.startsWith('!setmusic')) {
        if (!message.member.permissions.has(PermissionsBitField.Flags.ManageChannels)) {
            return message.reply('คุณไม่มีสิทธิ์ในการตั้งค่าช่องเพลง!');
        }

        config.musicChannelId = message.channel.id;
        fs.writeFileSync('./config.json', JSON.stringify(config, null, 2));

        message.reply(`ตั้งค่าให้ช่องนี้ ${message.channel.toString()} เป็นช่องสำหรับส่งคำสั่งเพลงแล้ว!`);
    }

    // --- 2. การตรวจสอบช่องสำหรับคำสั่งเพลงอื่นๆ ทั้งหมด ---
    const musicCommands = ['!play', '!join', '!leave', '!queue', '!skip']; 
    if (musicCommands.includes(message.content.split(' ')[0])) {
        if (config.musicChannelId && message.channel.id !== config.musicChannelId) {
            const correctChannel = message.guild.channels.cache.get(config.musicChannelId);
            if (correctChannel) {
                return message.reply(`กรุณาใช้คำสั่งเพลงในช่อง ${correctChannel.toString()} ครับ`);
            } else {
                return message.reply('ไม่พบช่องเพลงที่ตั้งค่าไว้ กรุณาใช้ `!setmusic` เพื่อตั้งค่าใหม่');
            }
        }
    }
    
    // --- 3. คำสั่งเล่นเพลงจาก YouTube !play <URL> ---
    if (message.content.startsWith('!play')) {
        const args = message.content.split(' '); // แยกคำสั่งและ URL
        const url = args[1]; // URL จะอยู่ที่ Argument ที่สอง

        if (!url || !ytdl.validateURL(url)) { //
            return message.reply('กรุณาใส่ลิงก์ YouTube ที่ถูกต้องหลังคำสั่ง `!play` ครับ');
        }

        if (!message.member.voice.channel) {
            return message.reply('คุณต้องอยู่ในช่องเสียงก่อนที่จะเปิดเพลงครับ!');
        }
        
        try {
            // เข้าร่วมช่องเสียง
            const connection = joinVoiceChannel({
                channelId: message.member.voice.channel.id,
                guildId: message.guild.id,
                adapterCreator: message.guild.voiceAdapterCreator,
            });

            // รอจนกว่าการเชื่อมต่อจะพร้อม (สำคัญมากสำหรับ @discordjs/voice)
            await entersState(connection, VoiceConnectionStatus.Ready, 20000);

            // สร้างสตรีมเสียงจาก YouTube โดยใช้ ytdl-core
            const stream = ytdl(url, { filter: 'audioonly', quality: 'highestaudio' }); //
            const resource = createAudioResource(stream);
            const player = createAudioPlayer();

            connection.subscribe(player);
            player.play(resource);

            // ดึงข้อมูลเพลงมาแสดงชื่อ (ทางเลือก)
            const info = await ytdl.getInfo(url);
            message.channel.send(`เริ่มเล่นเพลง: **${info.videoDetails.title}** แล้วครับ!`);

            player.on('error', error => {
                console.error(`Error: ${error.message}`);
                message.channel.send('เกิดข้อผิดพลาดในการเล่นเพลงครับ');
            });

        } catch (error) {
            console.error(error);
            message.reply('ไม่สามารถเล่นเพลงจากลิงก์นี้ได้ครับ ลองตรวจสอบลิงก์หรือสิทธิ์ของบอท');
        }
    }

    if (message.content === '!leave') {
        const connection = client.voice.adapters.get(message.guild.id);
        if (connection) {
            connection.destroy();
            message.channel.send('ออกจากช่องเสียงแล้วครับ');
        } else {
            message.reply('บอทไม่ได้อยู่ในช่องเสียงครับ');
        }
    }
});
